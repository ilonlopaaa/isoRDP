name: Windows RDP Setup

on:
  workflow_dispatch:  # Hanya manual run

jobs:
  setup-rdp:
    runs-on: windows-latest
    timeout-minutes: 60  # Test 1 jam dulu, nanti ganti ke 355 kalo udah work

    steps:
    # STEP 1: Setup RDP Basic
    - name: Setup Remote Desktop
      run: |
        echo "=== STEP 1: Enabling RDP ==="
        
        # Enable RDP
        reg add "HKLM\System\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
        
        # Disable NLA for easier connection
        reg add "HKLM\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v UserAuthentication /t REG_DWORD /d 0 /f
        
        # Add firewall rule
        netsh advfirewall firewall add rule name="RDP Port 3389" dir=in action=allow protocol=TCP localport=3389
        
        # Disable sleep
        powercfg -change -standby-timeout-ac 0
        powercfg -change -monitor-timeout-ac 0
        
        echo "‚úÖ RDP enabled successfully!"
        
    # STEP 2: Create User
    - name: Create RDP User
      run: |
        echo "=== STEP 2: Creating User ==="
        
        # Simple user creation with net command
        net user rdptest "TestPass123!" /add /Y
        net localgroup administrators rdptest /add
        net localgroup "Remote Desktop Users" rdptest /add
        
        echo "RDP_USER=rdptest" >> $env:GITHUB_ENV
        echo "RDP_PASS=TestPass123!" >> $env:GITHUB_ENV
        
        echo "‚úÖ User created: rdptest / TestPass123!"
        
    # STEP 3: Install Tailscale
    - name: Install Tailscale
      run: |
        echo "=== STEP 3: Installing Tailscale ==="
        
        # Download Tailscale
        curl -L https://pkgs.tailscale.com/stable/tailscale-setup-amd64.msi -o C:\tailscale.msi
        
        # Install silently
        msiexec /i C:\tailscale.msi /quiet /norestart
        
        # Wait for installation
        timeout /t 20 /nobreak
        
        echo "‚úÖ Tailscale installed!"
        
    # STEP 4: Connect Tailscale
    - name: Connect to Tailscale Network
      env:
        TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      run: |
        echo "=== STEP 4: Connecting Tailscale ==="
        
        # Wait for Tailscale service
        timeout /t 10 /nobreak
        
        # Connect with auth key
        & "C:\Program Files\Tailscale\tailscale.exe" up --authkey="$env:TAILSCALE_AUTH_KEY" --hostname="github-rdp"
        
        # Get Tailscale IP
        $ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
        
        if ($ip) {
            echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
            echo "‚úÖ Tailscale connected! IP: $ip"
        } else {
            echo "TAILSCALE_IP=NOT_ASSIGNED_YET" >> $env:GITHUB_ENV
            echo "‚ö†Ô∏è  IP not assigned yet, check in RDP session"
        }
        
    # STEP 5: Display Info
    - name: Show Connection Details
      run: |
        echo ""
        echo "=========================================="
        echo "üü¢ WINDOWS RDP READY FOR CONNECTION"
        echo "=========================================="
        echo "TAILSCALE IP: $env:TAILSCALE_IP"
        echo "USERNAME: $env:RDP_USER"
        echo "PASSWORD: $env:RDP_PASS"
        echo "=========================================="
        echo "üìå INSTRUCTIONS:"
        echo "1. Install Tailscale on your PC"
        echo "2. Connect to same Tailscale network"
        echo "3. Open Remote Desktop Connection"
        echo "4. Connect to: $env:TAILSCALE_IP:3389"
        echo "5. Login with credentials above"
        echo "=========================================="
        echo "‚è≥ This session will last: 1 hour (test mode)"
        echo "   Change timeout-minutes to 355 for 6 hours"
        echo "=========================================="
        echo ""
        
        # Keep-alive for workflow
        echo "Workflow will stay active for 55 minutes..."
        $counter = 0
        while ($counter -lt 55) {
            Start-Sleep -Seconds 60
            $counter++
            $remaining = 55 - $counter
            echo "[$(Get-Date)] Still running... $remaining minutes left"
        }
        
        echo "‚è∞ Test completed! Create new session if needed."
